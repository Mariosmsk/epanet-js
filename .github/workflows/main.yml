name: CI

on: [push]

jobs:
  build-epa-engine:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
      
    - name: Cache emscripten build
      id: cache-emscripten-build
      uses: actions/cache@v1
      with:
        path: 'packages/epanet-engine/dist'
        key: emscrip-${{ hashFiles('packages/epanet-engine/src/**')}}-${{ hashFiles('packages/epanet-engine/Dockerfile')}}-${{ hashFiles('packages/epanet-engine/build.sh')}}

    - name: Build emscripten docker container
      if: steps.cache-emscripten-build.outputs.cache-hit != 'true'
      run: yarn build:docker
    - name: Compile OWA-EPANET to JS
      if: steps.cache-emscripten-build.outputs.cache-hit != 'true'
      run:  yarn build:engine
  
  tests:
    
    runs-on: ubuntu-latest
    needs: [build-epa-engine]
    
    steps:
    - uses: actions/checkout@v1
    - name: Cache node modules
      uses: actions/cache@v1
      with:
        path: ~/.npm # npm cache files are stored in `~/.npm` on Linux/macOS
        key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock') }}
    - name: Install Dependencies
      run: yarn install
    - name: Running tests
      run: yarn test:CI

  lint:
    
    runs-on: ubuntu-latest
    needs: [build-epa-engine]
    
    steps:
    - uses: actions/checkout@v1
    - name: Cache node modules
      uses: actions/cache@v1
      with:
        path: ~/.npm # npm cache files are stored in `~/.npm` on Linux/macOS
        key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock') }}
    - name: Install Dependencies
      run: yarn install
    - name: Running linter
      run: yarn lint

  build:
    
    runs-on: ubuntu-latest
    needs: [build-epa-engine]
    
    steps:
    - uses: actions/checkout@v1
    - name: Cache node modules
      uses: actions/cache@v1
      with:
        path: ~/.npm # npm cache files are stored in `~/.npm` on Linux/macOS
        key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock') }}
    - name: Install Dependencies
      run: yarn install
    - name: Running tests
      run: yarn build


